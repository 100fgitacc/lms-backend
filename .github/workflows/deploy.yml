name: Deploy LMS Backend
on: { push: { branches: [ main ] }, workflow_dispatch: {} }
concurrency: { group: deploy-lms-backend, cancel-in-progress: true }

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_PORT: ${{ secrets.SSH_PORT || '22' }}

    steps:
      - uses: actions/checkout@v4

      - name: Prepare SSH key
        run: |
          echo "${{ secrets.SSH_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Ensure target dir
        run: |
          ssh -i key.pem -p "$SSH_PORT" -o StrictHostKeyChecking=no \
            "$SSH_USER@$SSH_HOST" "mkdir -p /var/www/lms-backend"

      - name: Upload sources (rsync to /var/www/lms-backend)
        run: |
          rsync -az --delete \
            --exclude '.git' --exclude '.github' --exclude 'node_modules' \
            --exclude '.env' \
            -e "ssh -i key.pem -p $SSH_PORT -o StrictHostKeyChecking=no" \
            ./ "$SSH_USER@$SSH_HOST:/var/www/lms-backend/"

      - name: Install deps & reload PM2
        run: |
          ssh -i key.pem -p "$SSH_PORT" -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" '
            set -e
            cd /var/www/lms-backend
            npm ci
            cd /var/www
            pm2 startOrReload ecosystem.config.js --only lms-backend || pm2 start ecosystem.config.js --only lms-backend
            pm2 save
          '
